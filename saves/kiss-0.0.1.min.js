define(function(){"use strict";return new function(){var a=this,b="id",c="[id]";this.keyAttr=function(a){b=a,c=["[",b,"]"].join("")},this.events=new function(){var a={};this.publish=function(b,c){a[b]&&$.each(a[b],function(){this.apply($,c||[])})},this.subscribe=function(b,c){return a[b]||(a[b]=[]),a[b].push(c),[b,c]},this.unsubscribe=function(b){var c=b[0];a[c]&&$.each(a[c],function(d){this==b[1]&&(a[c].splice(d,1),a[c].length||delete a[c])})},this.getSlot=function(){for(var b=Math.random().toString(36).substring(2,12);a[b];)b=Math.random().toString(36).substring(2,12);return b}},this.nested=function(d){var f,e=this;d&&(f={$html:d.$html,$attrs:d.$attrs,$props:d.$props},delete d.$html,delete d.$attrs,delete d.$props,$.extend(this,d)),this.load=function(a){this.$node=a,j(),f.$html||l(),f=void 0},this.$html=function(a){this.$html.untie&&this.$html.untie(),a.tie?(k(a()),this.$html.tie=a.tie(this.$html,k)):"function"==typeof a?k(a.apply(this)):k(a)};var g={},h={},i=function(a,b){var c="attr"==a?g:h;$.each(b,function(b,d){c[b]&&(c[b].untie&&c[b].untie(),delete c[b]),d.tie?(e.$node[a](b,d()),c[b]=function(c){e.$node[a](b,c)},d.tie(c[b],c[b])):"function"==typeof d?e.$node[a](b,d.apply(this.$node)):e.$node[a](b,d)})};this.$attrs=function(a){i("attr",a)},this.$props=function(a){i("prop",a)};var j=function(){f.$html&&e.$html(f.$html),f.$attrs&&e.$attrs(f.$attrs),f.$props&&e.$props(f.$props)},k=function(a){e.$node.html(a),l()},l=function(){var d=e.$node.find(c);d.length&&d.each(function(d,f){var g=$(f),h=g.attr(b),f=e[h];g.parents(c)[0]==e.$node[0]&&f&&(f.load||(e[h]=new a.nested(f)),e[h].load(g))})}},this.collection=function(a){$.extend(this,a),this.load=function(a){var b=this;this.$node=a,this.itemTemplate=this.$node.children().first()[0].outerHTML,this.$node.html(""),$.each(this.data,function(a,c){b.$node.append(d(b.itemTemplate,c))})};var d=function(a,d){var e=$(a),f=e.find(c);return f.each(function(a,c){var e=$(c),f=e.attr(b);e.html(d[f])}),e}},this.value=function(b){function e(b){return arguments.length?(c!==b&&(c=b,a.events.publish(d,[c])),this):c}var c=b,d=a.events.getSlot()+":change";return e.tie=function(b,c){b.untie&&b.untie();var e=a.events.subscribe(d,function(a){c.apply(b,[a])});return b.untie=function(){a.events.unsubscribe(e)},b},e},this.function=function(b){return function(){function g(){var g=c;return arguments.length&&(i(),e=Array.prototype.slice.call(arguments),h()),c=b.apply(null,f),c!==g&&a.events.publish(d,[c]),c}function h(){$.each(e,function(a,b){b.tie&&(f[a]=b(),e[a]=b.tie({},function(b){f[a]=b,g()}))})}function i(){$.each(e,function(a,b){b.untie&&b.untie()})}var c,d=a.events.getSlot()+":change",e=Array.prototype.slice.call(arguments),f=Array.prototype.slice.call(arguments);return g.tie=function(b,c){b.untie&&b.untie();var e=a.events.subscribe(d,function(a){c.apply(b,[a])});b.untie=function(){a.events.unsubscribe(e)}},h(),g}}}});